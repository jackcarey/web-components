{"version":3,"file":"index-DnU_gqUa.js","sources":["../../packages/document-pip/index.ts"],"sourcesContent":["//hacky type coercion to make the compiler happy\ntype WindowDPiP = Window & {\n  documentPictureInPicture?: any & {\n    window?: Window;\n  };\n};\n\nexport default class DocumentPiP extends HTMLElement {\n  static get observedAttributes() {\n    return ['disabled', 'id', 'position', 'width', 'height'];\n  }\n\n  static get enabledId() {\n    if (!document.pictureInPictureElement) {\n      return undefined;\n    }\n    return document.pictureInPictureElement?.id;\n  }\n\n  #root: ShadowRoot;\n  constructor() {\n    super();\n    this.#root = this.attachShadow({ mode: 'open' });\n  }\n\n  get disabled() {\n    return this.hasAttribute('disabled');\n  }\n\n  set disabled(val: Boolean) {\n    this.toggleAttribute('disabled', Boolean(val));\n  }\n\n  async setPiP(val: boolean) {\n    if (!val) {\n      if (document.pictureInPictureElement) {\n        await document.exitPictureInPicture();\n      }\n      return false;\n    } else {\n      // Open a Picture-in-Picture window.\n      const pipWindow = await window.documentPictureInPicture.requestWindow({\n        width: this.width ? parseInt(this.width) : 300,\n        height: this.height ? parseInt(this.height) : 200,\n      });\n\n      pipWindow.addEventListener('pagehide', this.#pipWindowClosedFn);\n    }\n    // Returns null if no pip window is currently open\n    if (!window.documentPictureInPicture.window) {\n      // Open a Picture-in-Picture window.\n      const pipWindow = await window.documentPictureInPicture.requestWindow({\n        width: videoPlayer.clientWidth,\n        height: videoPlayer.clientHeight + 50,\n      });\n\n      // Add pagehide listener to handle the case of the pip window being closed using the browser X button\n      pipWindow.addEventListener('pagehide', (event) => {\n        inPipMessage.style.display = 'none';\n        playerContainer.append(videoPlayer);\n      });\n\n      // Copy style sheets over from the initial document\n      // so that the player looks the same.\n      [...document.styleSheets].forEach((styleSheet) => {\n        try {\n          const cssRules = [...styleSheet.cssRules]\n            .map((rule) => rule.cssText)\n            .join('');\n          const style = document.createElement('style');\n\n          style.textContent = cssRules;\n          pipWindow.document.head.appendChild(style);\n        } catch (e) {\n          const link = document.createElement('link');\n\n          link.rel = 'stylesheet';\n          link.type = styleSheet.type;\n          link.media = styleSheet.media;\n          link.href = styleSheet.href;\n          pipWindow.document.head.appendChild(link);\n        }\n      });\n\n      // Move the player to the Picture-in-Picture window.\n      pipWindow.document.body.append(videoPlayer);\n\n      // Display a message to say it has been moved\n      inPipMessage.style.display = 'block';\n    } else {\n      inPipMessage.style.display = 'none';\n      playerContainer.append(videoPlayer);\n      window.documentPictureInPicture.window.close();\n    }\n  }\n\n  #checkboxChanged = ({ target }: Event) => {\n    this.setPiP((target as HTMLInputElement).checked);\n  };\n\n  #pipWindowEnteredFn = (event: Event) => {\n    const pipWindow = (window as WindowDPiP)?.documentPictureInPicture?.window;\n    pipWindow?.addEventListener('pagehide', this.#pipWindowClosedFn);\n    this.#render();\n  };\n\n  #pipWindowClosedFn = (event: PageTransitionEvent) => {\n    this.#render();\n  };\n\n  #render() {\n    const checked = !this.disabled && this.inUse;\n    if (!Boolean('documentPictureInPicture' in window)) {\n      this.#root.innerHTML = `<div id=\"not-available\">\n                    <slot name=\"not-available\">PiP not available</slot>\n                </div>`;\n    } else {\n      this.#root.innerHTML = `<input type=\"checkbox\" id=\"pip-toggle\" ${\n        !this.disabled ? 'disabled' : ''\n      } ${checked ? 'checked' : ''}/>\n                <label id=\"pip-toggle-label\" for=\"pip-toggle\">\n                    <slot name=\"toggle-label\">Picture-in-Picture</slot>\n                </label>\n                <div id=\"in-use\" style=\"display:none;\">\n                    <slot name=\"in-use\">PiP</slot>\n                </div>\n            <div id=\"in-pip\" style=\"display:none;\">\n                <slot name=\"in-pip\">In PiP</slot>\n            </div>\n            <div id=\"pip-container\">\n                <div id=\"content\">\n                    <slot name=\"content\"></slot>\n                    <slot></slot>\n                </div>\n            </div>`;\n      this.#root\n        .querySelector('input')\n        ?.addEventListener('change', this.#checkboxChanged);\n    }\n  }\n\n  get position() {\n    return this.getAttribute('position') ?? 'after';\n  }\n\n  set position(val: string) {\n    if (!val) {\n      this.removeAttribute('position');\n    }\n    if (['after', 'before'].includes(val)) {\n      this.setAttribute('position', val);\n    } else {\n      this.setAttribute('position', 'after');\n    }\n  }\n\n  get inUse() {\n    return DocumentPiP.enabledId && DocumentPiP.enabledId === this.id;\n  }\n\n  get width(): string | null {\n    return this.getAttribute('width');\n  }\n\n  set width(val: string) {\n    const asNum = parseInt(val);\n    if (!asNum || asNum < 0) {\n      this.removeAttribute('width');\n    } else {\n      this.setAttribute('width', asNum.toString());\n    }\n  }\n\n  get height(): string | null {\n    return this.getAttribute('height') ?? '';\n  }\n\n  set height(val: string) {\n    const asNum = parseInt(val);\n    if (!asNum || asNum < 0) {\n      this.removeAttribute('height');\n    } else {\n      this.setAttribute('height', asNum.toString());\n    }\n  }\n\n  connectedCallback() {\n    this.#render();\n    if ('documentPictureInPicture' in window) {\n      (window.documentPictureInPicture as WindowDPiP).addEventListener(\n        'enter',\n        this.#pipWindowEnteredFn\n      );\n    }\n  }\n\n  disconnectedCallback() {\n    if ('documentPictureInPicture' in window) {\n      (window.documentPictureInPicture as WindowDPiP).removeEventListener(\n        'enter',\n        this.#render\n      );\n      const pipWindow = (window as WindowDPiP)?.documentPictureInPicture\n        ?.window;\n      if (pipWindow) {\n        pipWindow?.removeEventListener('pagehide', this.#pipWindowClosedFn);\n      }\n    }\n  }\n\n  attributeChangedCallback(_name: string, oldValue: string, newValue: string) {\n    if (oldValue !== newValue) {\n      this.#render();\n    }\n  }\n}\n\nif (customElements && !customElements.get('document-pip')) {\n  customElements.define('document-pip', DocumentPiP);\n}\n"],"names":["_root","_checkboxChanged","_pipWindowEnteredFn","_pipWindowClosedFn","_DocumentPiP_instances","render_fn","_DocumentPiP","__privateAdd","target","event","_a","pipWindow","__privateGet","__privateMethod","__privateSet","val","styleSheet","cssRules","rule","style","link","asNum","_name","oldValue","newValue","checked","DocumentPiP"],"mappings":"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"}